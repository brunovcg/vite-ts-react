/* eslint-disable no-undef */
/* eslint-env node */
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

import { execSync } from "child_process";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const variablesFile = path.resolve(__dirname, "../src/styles/config/variables.css");
const outputFile = path.resolve(__dirname, "../src/runtime/cssVariables.ts");

const parseCSSVariables = (content) => {
  const cssVariables = {};
  
  const variableRegex = /--([a-zA-Z0-9_-]+):\s*([^;]+);/g;
  
  let match;
  while ((match = variableRegex.exec(content)) !== null) {
    const fullName = match[1];
    const value = match[2].trim();
    
    const parts = fullName.split(/[-_]/);
    
    if (parts.length >= 2) {
      const [keyName, ...valueParts] = parts;
      const valueName = valueParts.join("_");
      
      if (!cssVariables[keyName]) {
        cssVariables[keyName] = {};
      }
      
      cssVariables[keyName][valueName] = value;
    }
  }
  
  return cssVariables;
};

const formatObject = (obj, indent = 2) => {
  const spaces = " ".repeat(indent);
  const entries = Object.entries(obj).map(([key, value]) => {
    const formattedKey = /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(key) ? key : `"${key}"`;
    
    if (typeof value === "object" && !Array.isArray(value)) {
      return `${spaces}${formattedKey}: {\n${formatObject(value, indent + 2)}\n${spaces}}`;
    }
    const escapedValue = value.replace(/"/g, '\\"');
    return `${spaces}${formattedKey}: "${escapedValue}"`;
  });
  
  return entries.join(",\n");
};

const main = () => {
  if (!fs.existsSync(variablesFile)) {
    console.error(`File not found: ${variablesFile}`);
    process.exit(1);
  }

  let content = fs.readFileSync(variablesFile, "utf-8");

  content = content.replace(/\/\*[\s\S]*?\*\//g, "");

  const cssVariables = parseCSSVariables(content);

  const fileContent = `// Do not edit this file manually 
// This file is auto-generated by scripts/generate-css-variables.js if src/styles/config/variables.css is edited

export const CSS_VARIABLES = {
${formatObject(cssVariables)}
} as const;

`;

  fs.writeFileSync(outputFile, fileContent);
  console.log(`Generated ${outputFile}`);

  try {
    execSync(`npx prettier --write ${outputFile}`, { stdio: "inherit" });
    console.log(`Prettified ${outputFile}`);
  } catch (error) {
    console.error(`Failed to prettify ${outputFile}:`, error);
  }
};

main();
